\section{Application to synthetic data}

The synthetic data application of the fast equivalent layer for magnetic data was conducted on a regular grid of  $80 \times 80$ points, totaling $N = 6,\, 400$ observation points. Three bodies were modeled: two prisms and a sphere with inclination, declination and intensity of $0^{\circ}$ and $45^{\circ}$ and $2\sqrt{2}$ A/m, respectively. The main field has inclination and declination of $10^{\circ}$ and $37^{\circ}$, respectively. Figure \ref{fig:model_mag_synthetic}a shows the synthetic data created for this test.

Using a classical linear inversion method (equation \ref{eq:estimated-p-parameter-space}) a predicted data was estimated in figure \ref{fig:predicted_synthetic_mag}a. The residuals between the observed (\ref{fig:model_mag_synthetic}b) and the predicted data (\ref{fig:predicted_synthetic_mag}a), with mean $0.3712$ nT and standart deviation of $0.2798$ nT is shown in figure \ref{fig:predicted_synthetic_mag}b. This process took $17.10$ seconds.

Using the CGLS method with the fast BTTB matrix-vector product a predicted data was estimated in figure \ref{fig:predicted_bccb_mag}a. The residuals between the observed (\ref{fig:model_mag_synthetic}b) and the predicted data (\ref{fig:predicted_bccb_mag}a), with mean $0.5150$ nT and standart deviation of $0.4363$ nT is shown in figure \ref{fig:predicted_bccb_mag}b. This process took $0.18$ seconds.

In figure \ref{fig:convergence_synthetic_mag} we have the convergence analysis of the CGLS method to estimate the equivalent sources parameter vector $\mathbf{d}(\hat{\mathbf{p}})$ used for this synthetic test. The squared euclidian norm of residuals decreases as expected, with good results at 50 iterations, stabilizing afterwards. This result shows that it is not necessary to run the conjugate gradient least square method at $N$ iterations to get a theoretically exactly solution (which in practice would never occur due to roundoff errors), as this could be very demanding to process even with a small layer with $N = 6,\, 400$ equivalent sources. Setting a minimum tolerance of the residuals is a good option to carry out this algorithm efficiently and still obtaining very good results. Another possibility is to set an invariance to the euclidian norm of residuals between iteractions, wich would increase algorithm runtime, but with smaller residuals. We chose the first option, as we achieve satisfatory results.

%======================================================================================
\subsection*{Tests with irregulars grids}
%======================================================================================

As shown in theory, a regular grid of observation points is needed to arise the BTTB matrix. In this section, we show the results when this algorithm is used directly into irregular grids of $N = 5 \, 000$ observation points. 
First, we set up a regular grid of $100 \times 50$ observation points in the $x$- and $y$-directions with a grid spacing of $\Delta x$ of $101.01$ m along the $x$-axis and $\Delta y$ of
$163.265$ m along the $y$-axis. Next, the $x$ and $y$ coordinates of the observations were also contaminated with pseudorandom Gaussian noise with zero mean and standard deviations of $10\%$, $30\%$ and $50\%$ of the $\Delta x$ and $\Delta y$ spacing.

Figure \ref{fig:model_mag_synthetic_irregular_10}a shows an irregular grid with standart deviations of $10\%$ along both $x$- and $y$-direction of the observation points. Using the classical approach the residuals between the observed (\ref{fig:model_mag_synthetic_irregular_10}b) and the predicted data (\ref{fig:predicted_synthetic_mag_irregular_10}a) has mean $0.3628$ nT, standart deviation of $0.2727$ nT and is shown in figure \ref{fig:predicted_synthetic_mag_irregular_10}b. Using the new approach of this work the residuals between the observed (\ref{fig:model_mag_synthetic_irregular_10}b) and the predicted data (\ref{fig:predicted_bccb_mag_irregular_10}a) has mean $0.6024$ nT, standart deviation of $0.4998$ nT and is shown in figure \ref{fig:predicted_bccb_mag_irregular_10}b.
In figure \ref{fig:convergence_synthetic_mag_irregular_10} we have the convergence analysis of the CGLS method to estimate the equivalent sources used for this synthetic test. The squared euclidian norm decreases as expected, with good results at 50 iterations, stabilizing afterwards.

Figure \ref{fig:model_mag_synthetic_irregular_20}a shows an irregular grid with standart deviations of $20\%$ along both $x$- and $y$-direction of the observation points. Using the classical approach the residuals between the observed (\ref{fig:model_mag_synthetic_irregular_20}b) and the predicted data (\ref{fig:predicted_synthetic_mag_irregular_20}a) has mean $0.3630$ nT, standart deviation of $0.2731$ nT and is shown in figure \ref{fig:predicted_synthetic_mag_irregular_20}b. Using the new approach of this work the residuals between the observed (\ref{fig:model_mag_synthetic_irregular_20}b) and the predicted data (\ref{fig:predicted_bccb_mag_irregular_20}a) has mean $0.7147$ nT, standart deviation of $0.5622$ nT and is shown in figure \ref{fig:predicted_bccb_mag_irregular_20}b.
In figure \ref{fig:convergence_synthetic_mag_irregular_20} we have the convergence analysis of the CGLS method to estimate the equivalent sources used for this synthetic test. The squared euclidian norm decreases as expected and stabilizing afterwards.

Figure \ref{fig:model_mag_synthetic_irregular_30}a shows an irregular grid with standart deviations of $30\%$ along both $x$- and $y$-direction of the observation points. Using the classical approach the residuals between the observed (\ref{fig:model_mag_synthetic_irregular_30}b) and the predicted data (\ref{fig:predicted_synthetic_mag_irregular_30}a) has mean $0.3634$ nT, standart deviation of $0.2735$ nT and is shown in figure \ref{fig:predicted_synthetic_mag_irregular_30}b. Using the new approach of this work the residuals between the observed (\ref{fig:model_mag_synthetic_irregular_30}b) and the predicted data (\ref{fig:predicted_bccb_mag_irregular_30}a) has mean $0.9788$ nT, standart deviation of $0.7462$ nT and is shown in figure \ref{fig:predicted_bccb_mag_irregular_30}b.
In figure \ref{fig:convergence_synthetic_mag_irregular_30} we have the convergence analysis of the CGLS method to estimate the equivalent sources used for this synthetic test. The squared euclidian norm decreases as expected in the begining, but starts increasing and not converging afterwards.

This results show that, when this approach is used in irregular grids, there is a limit of how much deviation the observation points can have before it starts to produce errors in predicted data. This is confirmed with the convergence analysis, when the irregularity is too large, the linear system stops converging.

Another set of tests were also made with the same previous grid configuration, but now with deviations in the $z$-\textit{direction}, i.e., the observation points were no longer in a plane. In the previous tests, the total-field anomaly was computed at $900$ m height. The $z $coordinate of the observations were contaminated with
pseudorandom Gaussian noise with zero mean and standard deviations of $5\%$, $10\%$, and $20\%$ of the $900$ height.

Figure \ref{fig:model_mag_synthetic_irregular_z5}a shows a regular grid of $100 \times 50$ in the $x$- and $y$-directions located on an uneven surface of observations where  the z coordinates were corrupted with a standard deviation of  $5\%$ of the height. Using the classical approach the residuals between the observed (\ref{fig:model_mag_synthetic_irregular_z5}b) and the predicted data (\ref{fig:predicted_synthetic_mag_irregular_z5}a) has mean $0.3712$ nT, standart deviation of $0.2870$ nT and is shown in figure \ref{fig:predicted_synthetic_mag_irregular_z5}b. Using the new approach of this work the residuals between the observed (\ref{fig:model_mag_synthetic_irregular_z5}b) and the predicted data (\ref{fig:predicted_bccb_mag_irregular_z5}a) has mean $0.9542$ nT, standart deviation of $0.8943$ nT and is shown in figure \ref{fig:predicted_bccb_mag_irregular_z5}b.
In figure \ref{fig:convergence_synthetic_mag_irregular_z5} we have the convergence analysis of the CGLS method to estimate the equivalent sources used for this synthetic test. The squared euclidian norm decreases as expected, with good results at 50 iterations, stabilizing afterwards.

Figure \ref{fig:model_mag_synthetic_irregular_z10}a shows  a regular grid of $100 \times 50$ in the $x$- and $y$-directions located on an uneven surface of observations where  the z coordinates were corrupted with a standard deviation of  $10\%$ of the height. Using the classical approach the residuals between the observed (\ref{fig:model_mag_synthetic_irregular_z10}b) and the predicted data (\ref{fig:predicted_synthetic_mag_irregular_z10}a) has mean $0.3865$ nT, standart deviation of $0.3216$ nT and is shown in figure \ref{fig:predicted_synthetic_mag_irregular_z10}b. Using the new approach of this work the residuals between the observed (\ref{fig:model_mag_synthetic_irregular_z10}b) and the predicted data (\ref{fig:predicted_bccb_mag_irregular_z10}a) has mean $1.6105$ nT, standart deviation of $1.6231$ nT and is shown in figure \ref{fig:predicted_bccb_mag_irregular_z10}b.
In figure \ref{fig:convergence_synthetic_mag_irregular_z10} we have the convergence analysis of the CGLS method to estimate the equivalent sources used for this synthetic test. The squared euclidian norm decreases as expected, with good results at 50 iterations, stabilizing afterwards.

Figure \ref{fig:model_mag_synthetic_irregular_z20}a shows  a regular grid of $100 \times 50$ in the $x$- and $y$-directions located on an uneven surface of observations where  the z coordinates were corrupted with a standard deviation of  $20\%$ of the height. Using the classical approach the residuals between the observed (\ref{fig:model_mag_synthetic_irregular_z20}b) and the predicted data (\ref{fig:predicted_synthetic_mag_irregular_z20}a) has mean $0.4155$ nT, standart deviation of $0.4005$ nT and is shown in figure \ref{fig:predicted_synthetic_mag_irregular_z20}b. Using the new approach of this work the residuals between the observed (\ref{fig:model_mag_synthetic_irregular_z20}b) and the predicted data (\ref{fig:predicted_bccb_mag_irregular_z20}a) has mean $6.6220$ nT, standart deviation of $5.901$ nT and is shown in figure \ref{fig:predicted_bccb_mag_irregular_z20}b.
In figure \ref{fig:convergence_synthetic_mag_irregular_z20} we have the convergence analysis of the CGLS method to estimate the equivalent sources used for this synthetic test. The squared euclidian norm decreases slower than previous tests and starts increasing afterwards showing that the convergence is not possible.

Once again, we observe that while the classical linear inversion method can predict the data even with high irregularities in the observation points grid, the method presented in this work stars to create errors in the estimative. Through the convergence graphs it is possible to see the increase of the squared euclidian norm of the residuals, but the sensitivity to uncertainties in the z coordinates of the observations is higher than the the sensitivity to uncertainties in the $x$ and $y$ coordinates of the observations. With an average of $20\%$ of deviation in the $z$-\textit{direction} the system stopped converging while only at an average deviation of $30\%$ in the $x$-\textit{direction} and $30\%$ in the $y$-\textit{direction} that the same convergence problem occured.